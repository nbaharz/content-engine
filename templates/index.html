<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupanya Content Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <!-- TOPBAR -->
    <nav class="topbar">
        <div class="topbar-inner">
            <div class="topbar-brand">
                <div class="brand-icon">
                    <i data-lucide="zap"></i>
                </div>
                <span class="brand-name">Grupanya</span>
                <span class="brand-badge">Content Engine</span>
            </div>
            <div class="topbar-meta">
                <span class="status-dot"></span>
                <span>Active</span>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <i data-lucide="moon" class="icon-moon"></i>
                    <i data-lucide="sun" class="icon-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="page-header">
            <h1>Campaigns</h1>
            <p>Generate campaign visuals with AI or automate Instagram posting.</p>
        </div>

        <!-- ADD CAMPAIGN BY URL -->
        <div class="card">
            <h2>
                <span class="section-icon"><i data-lucide="link" style="width:16px;height:16px;"></i></span>
                Add Campaign by URL
            </h2>
            <div class="url-input-group">
                <input type="url" id="campaignUrl" class="url-input" placeholder="Paste campaign URL (e.g. https://www.grupanya.com/...)">
                <button id="addCampaignBtn" class="btn btn-primary btn-add">
                    <span class="btn-text"><i data-lucide="plus-circle" style="width:16px;height:16px;"></i> Add Campaign</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Analyzing...
                    </span>
                </button>
            </div>
            <div id="addCampaignError" class="alert alert-error" style="display: none;">
                <span class="alert-icon"><i data-lucide="alert-triangle" style="width:16px;height:16px;"></i></span>
                <span id="addCampaignErrorMsg"></span>
            </div>
            <div id="addCampaignSuccess" class="alert alert-success" style="display: none;">
                <span class="alert-icon"><i data-lucide="check-circle" style="width:16px;height:16px;"></i></span>
                <span id="addCampaignSuccessMsg"></span>
            </div>
        </div>

        <!-- SELECT CAMPAIGN + MODES -->
        <div class="card">
            <h2>
                <span class="section-icon"><i data-lucide="megaphone" style="width:16px;height:16px;"></i></span>
                Select Campaign
            </h2>
            <div class="campaign-selector">
                <select id="campaignSelect" class="campaign-dropdown">
                    <option value="">Select a campaign...</option>
                    {% for campaign in campaigns %}
                    <option value="{{ campaign.id }}"
                            data-title="{{ campaign.title }}"
                            data-category="{{ campaign.category }}"
                            data-discount="{{ campaign.discount }}"
                            data-negative-prompt="{{ campaign.negative_prompt | default('', true) }}"
                            data-url="{{ campaign.url }}">
                        {% if campaign.title %}
                            {{ campaign.title }} - {{ campaign.discount }} discount
                        {% else %}
                            {{ campaign.url | truncate(60) }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div id="campaignInfo" class="campaign-info" style="display: none;">
                <div class="info-item">
                    <span class="info-label">Campaign</span>
                    <input type="text" id="infoTitle" class="info-edit-input">
                </div>
                <div class="info-item">
                    <span class="info-label">Category</span>
                    <input type="text" id="infoCategory" class="info-edit-input">
                </div>
                <div class="info-item">
                    <span class="info-label">Discount</span>
                    <input type="text" id="infoDiscount" class="info-edit-input info-edit-discount">
                </div>
                <div class="info-item">
                    <span class="info-label">Negative Prompt</span>
                    <input type="text" id="infoNegativePrompt" class="info-edit-input" placeholder="no illustration, no cartoon, no 3D render...">
                </div>
                <button id="saveEditBtn" class="btn btn-success btn-save">
                    <i data-lucide="save" style="width:14px;height:14px;"></i> Save
                </button>
            </div>

            <!-- MAIN FLOW TABS -->
            <div id="primaryTabContainer" class="primary-tabs" style="display: none;">
                <button id="tabCampaignVisual" class="primary-tab active" data-tab="campaign-visual">
                    <i data-lucide="images" style="width:16px;height:16px;"></i>
                    Generate Campaign Visual
                </button>
                <button id="tabInstagramFlow" class="primary-tab" data-tab="instagram">
                    <i data-lucide="instagram" style="width:16px;height:16px;"></i>
                    Instagram Post Automation
                </button>
            </div>

            <!-- ========== PANEL 2: INSTAGRAM POST AUTOMATION ========== -->
            <div id="panelInstagramFlow" class="tab-panel" style="display: none;">
                <!-- SUB TAB BUTTONS -->
                <div id="modeTabContainer" class="mode-tabs" style="display: none;">
                    <button id="tabManual" class="mode-tab active" data-tab="manual">
                        <i data-lucide="upload" style="width:16px;height:16px;"></i>
                        Upload Images Manually
                    </button>
                    <button id="tabAI" class="mode-tab" data-tab="ai">
                        <i data-lucide="sparkles" style="width:16px;height:16px;"></i>
                        Generate with AI
                    </button>
                </div>

                <!-- ========== PANEL A: MANUAL IMAGE UPLOAD ========== -->
                <div id="panelManual" class="tab-panel" style="display: none;">

                <!-- Image Upload -->
                <div class="multi-upload-area">
                    <input type="file" id="manualImageFiles" accept="image/*" multiple style="display: none;">
                    <button id="selectManualFilesBtn" class="btn btn-secondary">
                        <i data-lucide="image-plus" style="width:16px;height:16px;"></i> Select Images
                    </button>
                    <div id="manualFilesPreview" class="files-preview"></div>
                </div>

                <!-- Post Type: Collage / Carousel -->
                <div class="post-type-selector">
                    <label>Post Type</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manualPostType" value="collage" checked>
                            <span>Collage (Single Image)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manualPostType" value="carousel">
                            <span>Carousel (Swipeable)</span>
                        </label>
                    </div>
                </div>

                <!-- Collage Style (visible when collage is selected) -->
                <div id="manualLayoutSelector" class="post-type-selector">
                    <label>Collage Style</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manualCollageLayout" value="feature" checked>
                            <span>Feature (1 Large + Smaller)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manualCollageLayout" value="full_bleed">
                            <span>Grid (Equal Size)</span>
                        </label>
                    </div>
                </div>

                <!-- Poster Mode Toggle -->
                <div class="poster-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="manualPosterMode">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Poster Mode (overlay campaign info on the image)</span>
                    </label>
                </div>

                <!-- Preview Button -->
                <button id="manualPreviewBtn" class="btn btn-primary btn-block" disabled>
                    <span class="btn-text"><i data-lucide="eye" style="width:16px;height:16px;"></i> Preview</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Creating...
                    </span>
                </button>

                <!-- Preview Area -->
                <div id="manualPreview" style="display: none; margin-top: 1.5rem;">
                    <h3>Preview</h3>
                    <div class="image-container">
                        <img id="manualPreviewImage" src="" alt="Preview">
                    </div>

                    <!-- Poster Adjuster (visible in poster mode) -->
                    <div id="manualPosterAdjuster" class="position-adjuster" style="display: none;">
                        <label>Edit Poster</label>
                        <div class="edit-field">
                            <span class="edit-label">Title</span>
                            <input type="text" id="manualPosterTitle" class="edit-input" placeholder="Campaign title">
                        </div>
                        <div class="edit-field">
                            <span class="edit-label">Discount</span>
                            <input type="text" id="manualPosterDiscount" class="edit-input edit-input-short" placeholder="Discount info">
                        </div>
                        <div class="edit-field">
                            <span class="edit-label">Position</span>
                            <div class="slider-row">
                                <span class="slider-label">Up</span>
                                <input type="range" id="manualPositionSlider" min="20" max="85" value="65" class="position-slider">
                                <span class="slider-label">Down</span>
                            </div>
                        </div>
                        <button id="manualApplyPositionBtn" class="btn btn-secondary btn-sm">
                            <span class="btn-text"><i data-lucide="refresh-cw" style="width:14px;height:14px;"></i> Apply</span>
                            <span class="btn-loader" style="display: none;">
                                <span class="spinner"></span> Rendering...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- AI Caption Generation -->
                <div style="margin-top: 1.5rem;">
                    <button id="generateCaptionBtn" class="btn btn-primary btn-block" disabled>
                        <span class="btn-text"><i data-lucide="message-square" style="width:16px;height:16px;"></i> Generate AI Caption</span>
                        <span class="btn-loader" style="display: none;">
                            <span class="spinner"></span> Generating caption...
                        </span>
                    </button>
                    <div class="text-container" style="margin-top: 1rem;">
                        <textarea id="manualCaption" rows="4" placeholder="Caption will appear here... (generate with AI or write your own)"></textarea>
                    </div>
                </div>

                <!-- Post to Instagram -->
                <div class="action-buttons multi-actions" style="margin-top: 0.75rem;">
                    <button id="manualInstagramBtn" class="btn btn-instagram" disabled>
                        <i data-lucide="send" style="width:16px;height:16px;"></i> Post to Instagram
                    </button>
                </div>
                </div>

                <!-- ========== PANEL B: GENERATE POST WITH AI ========== -->
                <div id="panelAI" class="tab-panel" style="display: none;">

                <!-- Poster Mode Toggle -->
                <div class="poster-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="aiPosterMode">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Poster Mode (overlay campaign info on the image)</span>
                    </label>
                </div>

                <!-- Generate Content Button -->
                <button id="generateBtn" class="btn btn-primary btn-block">
                    <span class="btn-text"><i data-lucide="wand-2" style="width:16px;height:16px;"></i> Generate Content</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Generating...
                    </span>
                </button>

                <!-- AI Result Area -->
                <div id="aiResultSection" style="display: none; margin-top: 1.5rem;">
                    <h3>Image</h3>
                    <div class="image-container">
                        <img id="aiGeneratedImage" src="" alt="Campaign Image">
                    </div>

                    <div class="text-container" style="margin-top: 1.5rem;">
                        <h3>Instagram Post Text</h3>
                        <textarea id="aiGeneratedText" rows="6" placeholder="Caption will appear here..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button id="aiCopyTextBtn" class="btn btn-secondary">
                            <i data-lucide="copy" style="width:16px;height:16px;"></i> Copy Text
                        </button>
                        <button id="aiDownloadBtn" class="btn btn-success">
                            <i data-lucide="download" style="width:16px;height:16px;"></i> Save to Desktop
                        </button>
                        <button id="aiInstagramBtn" class="btn btn-instagram">
                            <i data-lucide="send" style="width:16px;height:16px;"></i> Post to Instagram
                        </button>
                    </div>
                </div>
            </div>
            </div>

            <!-- ========== PANEL 1: GENERATE CAMPAIGN VISUAL ========== -->
            <div id="panelCampaignVisual" class="tab-panel" style="display: none;">
                <p class="section-desc">Generate visuals using campaign details with AI. Optionally upload reference images.</p>

                <div class="post-type-selector">
                    <label for="visualNumImages">Number of Images to Generate</label>
                    <select id="visualNumImages" class="campaign-dropdown">
                        <option value="1" selected>1 Image</option>
                        <option value="2">2 Images</option>
                        <option value="3">3 Images</option>
                        <option value="4">4 Images</option>
                    </select>
                </div>

                <div class="multi-upload-area">
                    <input type="file" id="visualRefFiles" accept="image/*" multiple style="display: none;">
                    <button id="selectVisualRefFilesBtn" class="btn btn-secondary">
                        <i data-lucide="image-plus" style="width:16px;height:16px;"></i> Select Reference Images (Optional)
                    </button>
                    <div id="visualRefFilesPreview" class="files-preview"></div>
                </div>

                <button id="visualGenerateBtn" class="btn btn-primary btn-block">
                    <span class="btn-text"><i data-lucide="wand-2" style="width:16px;height:16px;"></i> Generate Image</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Generating...
                    </span>
                </button>

                <div id="visualGenerateResult" style="display: none; margin-top: 1.5rem;">
                    <h3>Generated Images</h3>
                    <div id="visualGenerateImages"></div>
                    <div class="action-buttons" style="margin-top: 1rem;">
                        <button id="visualDownloadBtn" class="btn btn-success">
                            <i data-lucide="download" style="width:16px;height:16px;"></i> Download Images
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ERROR MESSAGE -->
        <div id="errorAlert" class="alert alert-error" style="display: none;">
            <span class="alert-icon"><i data-lucide="alert-triangle" style="width:16px;height:16px;"></i></span>
            <span id="errorMessage"></span>
        </div>
    </main>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== THEME TOGGLE ==========
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.body.classList.add('theme-transitioning');
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            setTimeout(() => document.body.classList.remove('theme-transitioning'), 350);
        });

        const campaignSelect = document.getElementById('campaignSelect');
        const generateBtn = document.getElementById('generateBtn');
        const campaignInfo = document.getElementById('campaignInfo');
        const errorAlert = document.getElementById('errorAlert');
        const modeTabContainer = document.getElementById('modeTabContainer');
        const primaryTabContainer = document.getElementById('primaryTabContainer');

        // ========== ADD CAMPAIGN BY URL ==========
        const addCampaignBtn = document.getElementById('addCampaignBtn');
        const campaignUrlInput = document.getElementById('campaignUrl');
        const addCampaignError = document.getElementById('addCampaignError');
        const addCampaignSuccess = document.getElementById('addCampaignSuccess');

        addCampaignBtn.addEventListener('click', async function() {
            const url = campaignUrlInput.value.trim();
            if (!url) {
                addCampaignError.style.display = 'flex';
                document.getElementById('addCampaignErrorMsg').textContent = 'Please enter a URL';
                return;
            }

            addCampaignBtn.disabled = true;
            addCampaignBtn.querySelector('.btn-text').style.display = 'none';
            addCampaignBtn.querySelector('.btn-loader').style.display = 'inline-flex';
            addCampaignError.style.display = 'none';
            addCampaignSuccess.style.display = 'none';

            try {
                const response = await fetch('/add-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An error occurred');

                const campaign = data.campaign;
                const option = document.createElement('option');
                option.value = campaign.id;
                option.dataset.title = campaign.title;
                option.dataset.category = campaign.category;
                option.dataset.discount = campaign.discount;
                option.dataset.negativePrompt = campaign.negative_prompt || '';
                option.dataset.url = url;
                option.textContent = `${campaign.title} - ${campaign.discount} discount`;
                campaignSelect.appendChild(option);

                campaignSelect.value = campaign.id;
                campaignSelect.dispatchEvent(new Event('change'));

                addCampaignSuccess.style.display = 'flex';
                document.getElementById('addCampaignSuccessMsg').textContent =
                    `Campaign "${campaign.title}" added!`;
                campaignUrlInput.value = '';

            } catch (error) {
                addCampaignError.style.display = 'flex';
                document.getElementById('addCampaignErrorMsg').textContent = error.message;
            } finally {
                addCampaignBtn.disabled = false;
                addCampaignBtn.querySelector('.btn-text').style.display = 'inline';
                addCampaignBtn.querySelector('.btn-loader').style.display = 'none';
            }
        });

        campaignUrlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') addCampaignBtn.click();
        });

        // ========== CAMPAIGN SELECTION ==========
        campaignSelect.addEventListener('change', async function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
                campaignInfo.style.display = 'block';
                primaryTabContainer.style.display = 'flex';
                modeTabContainer.style.display = 'flex';

                // Auto-scrape if fields are empty
                if (!selectedOption.dataset.title) {
                    generateBtn.disabled = true;
                    document.getElementById('generateCaptionBtn').disabled = true;
                    document.getElementById('infoTitle').value = '';
                    document.getElementById('infoCategory').value = '';
                    document.getElementById('infoDiscount').value = '';

                    const saveBtn = document.getElementById('saveEditBtn');
                    const origSaveText = saveBtn.textContent;
                    saveBtn.textContent = 'Analyzing...';
                    saveBtn.disabled = true;

                    try {
                        const resp = await fetch('/scrape-campaign', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ campaign_id: parseInt(this.value) })
                        });
                        const data = await resp.json();
                        if (!resp.ok) throw new Error(data.error);

                        const c = data.campaign;
                        selectedOption.dataset.title = c.title;
                        selectedOption.dataset.category = c.category;
                        selectedOption.dataset.discount = c.discount;
                        selectedOption.dataset.negativePrompt = c.negative_prompt || '';
                        selectedOption.textContent = `${c.title} - ${c.discount} discount`;

                        document.getElementById('infoTitle').value = c.title;
                        document.getElementById('infoCategory').value = c.category;
                        document.getElementById('infoDiscount').value = c.discount;
                        document.getElementById('infoNegativePrompt').value = c.negative_prompt || '';
                        generateBtn.disabled = false;
                        document.getElementById('generateCaptionBtn').disabled = false;
                    } catch (err) {
                        errorAlert.style.display = 'flex';
                        document.getElementById('errorMessage').textContent = 'Scrape error: ' + err.message;
                    } finally {
                        saveBtn.textContent = origSaveText;
                        saveBtn.disabled = false;
                    }
                } else {
                    document.getElementById('infoTitle').value = selectedOption.dataset.title;
                    document.getElementById('infoCategory').value = selectedOption.dataset.category;
                    document.getElementById('infoDiscount').value = selectedOption.dataset.discount;
                    document.getElementById('infoNegativePrompt').value = selectedOption.dataset.negativePrompt || '';
                    generateBtn.disabled = false;
                    document.getElementById('generateCaptionBtn').disabled = false;
                }
                // Activate the first main tab
                if (document.getElementById('panelInstagramFlow').style.display === 'none' &&
                    document.getElementById('panelCampaignVisual').style.display === 'none') {
                    switchPrimaryTab('campaign-visual');
                }
            } else {
                campaignInfo.style.display = 'none';
                primaryTabContainer.style.display = 'none';
                modeTabContainer.style.display = 'none';
                document.getElementById('panelInstagramFlow').style.display = 'none';
                document.getElementById('panelCampaignVisual').style.display = 'none';
                document.getElementById('panelManual').style.display = 'none';
                document.getElementById('panelAI').style.display = 'none';
                generateBtn.disabled = true;
                document.getElementById('generateCaptionBtn').disabled = true;
            }

            document.getElementById('aiResultSection').style.display = 'none';
            document.getElementById('manualPreview').style.display = 'none';
            document.getElementById('visualGenerateResult').style.display = 'none';
            errorAlert.style.display = 'none';
        });

        // Save campaign info
        document.getElementById('saveEditBtn').addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            const newTitle = document.getElementById('infoTitle').value.trim();
            const newCategory = document.getElementById('infoCategory').value.trim();
            const newDiscount = document.getElementById('infoDiscount').value.trim();
            const newNegativePrompt = document.getElementById('infoNegativePrompt').value.trim();

            if (!newTitle || !newCategory || !newDiscount) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/update-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: parseInt(campaignId),
                        title: newTitle,
                        category: newCategory,
                        discount: newDiscount,
                        negative_prompt: newNegativePrompt
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                const selectedOption = campaignSelect.options[campaignSelect.selectedIndex];
                selectedOption.dataset.title = newTitle;
                selectedOption.dataset.category = newCategory;
                selectedOption.dataset.discount = newDiscount;
                selectedOption.dataset.negativePrompt = newNegativePrompt;
                selectedOption.textContent = `${newTitle} - ${newDiscount} discount`;

                const originalText = this.textContent;
                this.textContent = 'Saved!';
                this.classList.add('btn-success-flash');
                setTimeout(() => { this.textContent = originalText; this.classList.remove('btn-success-flash'); }, 2000);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // ========== MAIN TAB SWITCHING ==========
        const tabInstagramFlow = document.getElementById('tabInstagramFlow');
        const tabCampaignVisual = document.getElementById('tabCampaignVisual');
        const panelInstagramFlow = document.getElementById('panelInstagramFlow');
        const panelCampaignVisual = document.getElementById('panelCampaignVisual');

        function switchPrimaryTab(tabName) {
            tabInstagramFlow.classList.toggle('active', tabName === 'instagram');
            tabCampaignVisual.classList.toggle('active', tabName === 'campaign-visual');
            panelInstagramFlow.style.display = tabName === 'instagram' ? 'block' : 'none';
            panelCampaignVisual.style.display = tabName === 'campaign-visual' ? 'block' : 'none';

            if (tabName === 'instagram') {
                modeTabContainer.style.display = 'flex';
                if (panelManual.style.display === 'none' && panelAI.style.display === 'none') {
                    switchTab('manual');
                }
            } else {
                modeTabContainer.style.display = 'none';
                panelManual.style.display = 'none';
                panelAI.style.display = 'none';
            }
        }

        tabInstagramFlow.addEventListener('click', () => switchPrimaryTab('instagram'));
        tabCampaignVisual.addEventListener('click', () => switchPrimaryTab('campaign-visual'));

        // ========== SUB TAB SWITCHING ==========
        const tabManual = document.getElementById('tabManual');
        const tabAI = document.getElementById('tabAI');
        const panelManual = document.getElementById('panelManual');
        const panelAI = document.getElementById('panelAI');

        function switchTab(tabName) {
            tabManual.classList.toggle('active', tabName === 'manual');
            tabAI.classList.toggle('active', tabName === 'ai');
            panelManual.style.display = tabName === 'manual' ? 'block' : 'none';
            panelAI.style.display = tabName === 'ai' ? 'block' : 'none';
        }

        tabManual.addEventListener('click', () => switchTab('manual'));
        tabAI.addEventListener('click', () => switchTab('ai'));

        // ========== GENERATE CAMPAIGN VISUAL ==========
        const visualRefFilesInput = document.getElementById('visualRefFiles');
        const selectVisualRefFilesBtn = document.getElementById('selectVisualRefFilesBtn');
        const visualRefFilesPreview = document.getElementById('visualRefFilesPreview');
        const visualGenerateBtn = document.getElementById('visualGenerateBtn');
        const visualNumImagesInput = document.getElementById('visualNumImages');
        let visualGeneratedBase64List = [];

        selectVisualRefFilesBtn.addEventListener('click', () => visualRefFilesInput.click());

        visualRefFilesInput.addEventListener('change', function() {
            const files = Array.from(this.files).slice(0, 4);
            visualRefFilesPreview.innerHTML = '';
            document.getElementById('visualGenerateResult').style.display = 'none';
            visualGeneratedBase64List = [];

            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Reference ${idx + 1}">
                        <span class="preview-number">${idx + 1}</span>
                    `;
                    visualRefFilesPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        visualGenerateBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) {
                alert('Please select a campaign first');
                return;
            }

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';
            document.getElementById('visualGenerateResult').style.display = 'none';
            errorAlert.style.display = 'none';

            try {
                const refFiles = Array.from(visualRefFilesInput.files).slice(0, 4);
                const numImages = parseInt(visualNumImagesInput.value, 10) || 1;
                const formData = new FormData();
                formData.append('campaign_id', campaignId);
                formData.append('num_images', String(numImages));
                refFiles.forEach(file => formData.append('files', file));

                const response = await fetch('/generate-website-content', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An error occurred');

                if (!data.images || !data.images.length || !data.images[0].image_base64) {
                    throw new Error('No generated image found');
                }

                visualGeneratedBase64List = data.images
                    .map(item => item.image_base64)
                    .filter(Boolean);

                if (!visualGeneratedBase64List.length) {
                    throw new Error('Failed to retrieve generated images');
                }

                const imagesWrap = document.getElementById('visualGenerateImages');
                imagesWrap.innerHTML = '';

                visualGeneratedBase64List.forEach((imageBase64, idx) => {
                    const card = document.createElement('div');
                    card.className = 'image-container';
                    card.style.marginBottom = '1rem';
                    card.innerHTML = `
                        <img src="data:image/jpeg;base64,${imageBase64}" alt="Generated Campaign Image ${idx + 1}">
                    `;
                    imagesWrap.appendChild(card);
                });

                document.getElementById('visualGenerateResult').style.display = 'block';
                document.getElementById('visualGenerateResult').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                errorAlert.style.display = 'flex';
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Download images (client-side)
        document.getElementById('visualDownloadBtn').addEventListener('click', function() {
            if (!visualGeneratedBase64List.length) return;
            const title = document.getElementById('infoTitle').value || 'campaign';
            const safeTitle = title.replace(/\s+/g, '_');

            visualGeneratedBase64List.forEach((imageBase64, idx) => {
                const link = document.createElement('a');
                link.href = 'data:image/jpeg;base64,' + imageBase64;
                link.download = `${safeTitle}_image_${idx + 1}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });

        // ========== MANUAL IMAGE UPLOAD TAB ==========
        let manualUploadedUrls = [];
        let manualCollageUrl = null;
        let manualPosterUrl = null;
        let manualRawBase64 = null;

        const manualFileInput = document.getElementById('manualImageFiles');
        const selectManualFilesBtn = document.getElementById('selectManualFilesBtn');
        const manualFilesPreview = document.getElementById('manualFilesPreview');
        const manualPreviewBtn = document.getElementById('manualPreviewBtn');
        const manualInstagramBtn = document.getElementById('manualInstagramBtn');
        const generateCaptionBtn = document.getElementById('generateCaptionBtn');

        // File selection
        selectManualFilesBtn.addEventListener('click', () => manualFileInput.click());

        manualFileInput.addEventListener('change', function() {
            manualFilesPreview.innerHTML = '';
            manualUploadedUrls = [];
            manualCollageUrl = null;
            manualPosterUrl = null;
            manualRawBase64 = null;
            document.getElementById('manualPreview').style.display = 'none';
            manualInstagramBtn.disabled = true;

            const postType = document.querySelector('input[name="manualPostType"]:checked').value;
            const maxFiles = postType === 'carousel' ? 10 : 4;
            const files = Array.from(this.files).slice(0, maxFiles);

            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${idx + 1}">
                        <span class="preview-number">${idx + 1}</span>
                    `;
                    manualFilesPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            manualPreviewBtn.disabled = files.length === 0;
        });

        // Post type change handler
        document.querySelectorAll('input[name="manualPostType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isCollage = this.value === 'collage';
                document.getElementById('manualLayoutSelector').style.display = isCollage ? 'block' : 'none';
                // Reset file selection
                manualFileInput.value = '';
                manualFilesPreview.innerHTML = '';
                manualUploadedUrls = [];
                manualCollageUrl = null;
                manualPosterUrl = null;
                document.getElementById('manualPreview').style.display = 'none';
                manualPreviewBtn.disabled = true;
                manualInstagramBtn.disabled = true;
            });
        });

        // Generate AI caption
        generateCaptionBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                const response = await fetch('/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campaign_id: parseInt(campaignId) })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                document.getElementById('manualCaption').value = data.caption;
            } catch (error) {
                alert('Caption generation error: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Preview button
        manualPreviewBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) { alert('Please select a campaign first'); return; }

            const files = Array.from(manualFileInput.files);
            const postType = document.querySelector('input[name="manualPostType"]:checked').value;
            const maxFiles = postType === 'carousel' ? 10 : 4;
            const slicedFiles = files.slice(0, maxFiles);
            if (!slicedFiles.length) return;

            const posterMode = document.getElementById('manualPosterMode').checked;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                if (postType === 'collage') {
                    const formData = new FormData();
                    slicedFiles.forEach(file => formData.append('files', file));

                    if (posterMode) {
                        formData.append('campaign_id', campaignId);
                        formData.append('ai_mode', 'false');

                        const response = await fetch('/create-posters', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);

                        manualPosterUrl = data.poster.image_url;
                        manualRawBase64 = data.raw_image_base64;
                        document.getElementById('manualPreviewImage').src =
                            'data:image/jpeg;base64,' + data.poster.image_base64;

                        const selOpt = campaignSelect.options[campaignSelect.selectedIndex];
                        document.getElementById('manualPosterTitle').value = selOpt.dataset.title || '';
                        document.getElementById('manualPosterDiscount').value = selOpt.dataset.discount || '';
                        document.getElementById('manualPosterAdjuster').style.display = 'block';
                    } else {
                        const layout = document.querySelector('input[name="manualCollageLayout"]:checked').value;
                        formData.append('layout', layout);

                        const response = await fetch('/create-collage', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);

                        manualCollageUrl = data.image_url;
                        document.getElementById('manualPreviewImage').src =
                            'data:image/jpeg;base64,' + data.image_base64;
                        document.getElementById('manualPosterAdjuster').style.display = 'none';
                    }
                } else {
                    // Carousel: upload images
                    const formData = new FormData();
                    slicedFiles.forEach(file => formData.append('files', file));

                    const response = await fetch('/upload-images', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    manualUploadedUrls = data.urls;

                    // Show first image as preview
                    if (slicedFiles.length > 0) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('manualPreviewImage').src = e.target.result;
                        };
                        reader.readAsDataURL(slicedFiles[0]);
                    }
                    document.getElementById('manualPosterAdjuster').style.display = 'none';
                }

                document.getElementById('manualPreview').style.display = 'block';
                manualInstagramBtn.disabled = false;
                document.getElementById('manualPreview').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Adjust poster position
        document.getElementById('manualApplyPositionBtn').addEventListener('click', async function() {
            if (!manualRawBase64) { alert('Please preview first'); return; }
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            const customTitle = document.getElementById('manualPosterTitle').value.trim();
            const customDiscount = document.getElementById('manualPosterDiscount').value.trim();
            if (!customTitle || !customDiscount) { alert('Title and discount fields cannot be empty'); return; }

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                const response = await fetch('/adjust-poster', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_image_base64: manualRawBase64,
                        campaign_id: parseInt(campaignId),
                        title_y_percent: parseInt(document.getElementById('manualPositionSlider').value),
                        title: customTitle,
                        discount: customDiscount,
                        mode: 'basic',
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                manualPosterUrl = data.poster.image_url;
                document.getElementById('manualPreviewImage').src =
                    'data:image/jpeg;base64,' + data.poster.image_base64;
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Manual Instagram post
        manualInstagramBtn.addEventListener('click', async function() {
            const caption = document.getElementById('manualCaption').value.trim();
            if (!caption) { alert('Please write a caption or generate one with AI!'); return; }

            const postType = document.querySelector('input[name="manualPostType"]:checked').value;

            if (!confirm('Do you want to post to Instagram?')) return;

            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Posting...';

            try {
                let response;
                if (postType === 'carousel' && manualUploadedUrls.length >= 2) {
                    response = await fetch('/post-instagram-carousel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_urls: manualUploadedUrls, caption: caption })
                    });
                } else {
                    const imageUrl = manualPosterUrl || manualCollageUrl;
                    if (!imageUrl) throw new Error('Please preview first');
                    response = await fetch('/post-instagram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_url: imageUrl, caption: caption })
                    });
                }

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                this.textContent = 'Posted!';
                alert(data.message + '\nPost ID: ' + data.post_id);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 3000);

            } catch (error) {
                alert('Error: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // ========== AI POST GENERATION TAB ==========
        let currentAiImageUrl = null;

        generateBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';
            document.getElementById('aiResultSection').style.display = 'none';
            errorAlert.style.display = 'none';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: parseInt(campaignId),
                        poster_mode: document.getElementById('aiPosterMode').checked
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An error occurred');

                document.getElementById('aiGeneratedImage').src =
                    'data:image/jpeg;base64,' + data.image_base64;
                document.getElementById('aiGeneratedText').value = data.post_text;
                document.getElementById('aiResultSection').style.display = 'block';
                currentAiImageUrl = data.image_url;

                document.getElementById('aiResultSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                errorAlert.style.display = 'flex';
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Copy text
        document.getElementById('aiCopyTextBtn').addEventListener('click', function() {
            const text = document.getElementById('aiGeneratedText').value;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                this.classList.add('btn-success-flash');
                setTimeout(() => { this.textContent = originalText; this.classList.remove('btn-success-flash'); }, 2000);
            });
        });

        // Save to desktop
        document.getElementById('aiDownloadBtn').addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Saving...';

            try {
                const response = await fetch(`/download/${campaignId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Save failed');

                this.textContent = 'Saved!';
                alert(data.message);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 2000);
            } catch (error) {
                alert('Error: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // AI Instagram post
        document.getElementById('aiInstagramBtn').addEventListener('click', async function() {
            const caption = document.getElementById('aiGeneratedText').value.trim();
            if (!currentAiImageUrl || !caption) {
                alert('Please generate content first!');
                return;
            }
            if (!confirm('Do you want to post to Instagram?')) return;

            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Posting...';

            try {
                const response = await fetch('/post-instagram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: currentAiImageUrl, caption: caption })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Posting failed');

                this.textContent = 'Posted!';
                alert(data.message + '\nPost ID: ' + data.post_id);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 3000);
            } catch (error) {
                alert('Error: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });
    </script>
</body>
</html>
