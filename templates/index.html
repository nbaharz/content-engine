<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupanya Content Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <!-- TOPBAR -->
    <nav class="topbar">
        <div class="topbar-inner">
            <div class="topbar-brand">
                <div class="brand-icon">
                    <i data-lucide="zap"></i>
                </div>
                <span class="brand-name">Grupanya</span>
                <span class="brand-badge">Content Engine</span>
            </div>
            <div class="topbar-meta">
                <span class="status-dot"></span>
                <span>Aktif</span>
                <button class="theme-toggle" id="themeToggle" title="Tema degistir">
                    <i data-lucide="moon" class="icon-moon"></i>
                    <i data-lucide="sun" class="icon-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="page-header">
            <h1>Kampanyalar</h1>
            <p>AI ile kampanya icerigi olusturun ve Instagram'a paylasin.</p>
        </div>

        <!-- KAMPANYA URL ILE EKLE -->
        <div class="card">
            <h2>
                <span class="section-icon"><i data-lucide="link" style="width:16px;height:16px;"></i></span>
                Kampanya URL'si ile Ekle
            </h2>
            <div class="url-input-group">
                <input type="url" id="campaignUrl" class="url-input" placeholder="Kampanya URL'sini yapistirin (orn: https://www.grupanya.com/...)">
                <button id="addCampaignBtn" class="btn btn-primary btn-add">
                    <span class="btn-text"><i data-lucide="plus-circle" style="width:16px;height:16px;"></i> Kampanya Ekle</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Analiz ediliyor...
                    </span>
                </button>
            </div>
            <div id="addCampaignError" class="alert alert-error" style="display: none;">
                <span class="alert-icon"><i data-lucide="alert-triangle" style="width:16px;height:16px;"></i></span>
                <span id="addCampaignErrorMsg"></span>
            </div>
            <div id="addCampaignSuccess" class="alert alert-success" style="display: none;">
                <span class="alert-icon"><i data-lucide="check-circle" style="width:16px;height:16px;"></i></span>
                <span id="addCampaignSuccessMsg"></span>
            </div>
        </div>

        <!-- KAMPANYA SEC + MODLAR -->
        <div class="card">
            <h2>
                <span class="section-icon"><i data-lucide="megaphone" style="width:16px;height:16px;"></i></span>
                Kampanya Secin
            </h2>
            <div class="campaign-selector">
                <select id="campaignSelect" class="campaign-dropdown">
                    <option value="">Bir kampanya secin...</option>
                    {% for campaign in campaigns %}
                    <option value="{{ campaign.id }}"
                            data-title="{{ campaign.title }}"
                            data-category="{{ campaign.category }}"
                            data-discount="{{ campaign.discount }}"
                            data-url="{{ campaign.url }}">
                        {% if campaign.title %}
                            {{ campaign.title }} - {{ campaign.discount }} indirim
                        {% else %}
                            {{ campaign.url | truncate(60) }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div id="campaignInfo" class="campaign-info" style="display: none;">
                <div class="info-item">
                    <span class="info-label">Kampanya</span>
                    <input type="text" id="infoTitle" class="info-edit-input">
                </div>
                <div class="info-item">
                    <span class="info-label">Kategori</span>
                    <input type="text" id="infoCategory" class="info-edit-input">
                </div>
                <div class="info-item">
                    <span class="info-label">Indirim</span>
                    <input type="text" id="infoDiscount" class="info-edit-input info-edit-discount">
                </div>
                <button id="saveEditBtn" class="btn btn-success btn-save">
                    <i data-lucide="save" style="width:14px;height:14px;"></i> Kaydet
                </button>
            </div>

            <!-- ANA AKIS TABLARI -->
            <div id="primaryTabContainer" class="primary-tabs" style="display: none;">
                <button id="tabInstagramFlow" class="primary-tab active" data-tab="instagram">
                    <i data-lucide="instagram" style="width:16px;height:16px;"></i>
                    Instagram Postu Üret
                </button>
                <button id="tabCampaignVisual" class="primary-tab" data-tab="campaign-visual">
                    <i data-lucide="images" style="width:16px;height:16px;"></i>
                    Kampanya Görseli Üret
                </button>
            </div>

            <!-- ========== PANEL 1: INSTAGRAM POSTU URET ========== -->
            <div id="panelInstagramFlow" class="tab-panel" style="display: none;">
                <!-- ALT TAB BUTONLARI -->
                <div id="modeTabContainer" class="mode-tabs" style="display: none;">
                    <button id="tabManual" class="mode-tab active" data-tab="manual">
                        <i data-lucide="upload" style="width:16px;height:16px;"></i>
                        Manuel Gorsel Yukle
                    </button>
                    <button id="tabAI" class="mode-tab" data-tab="ai">
                        <i data-lucide="sparkles" style="width:16px;height:16px;"></i>
                        AI ile Uret
                    </button>
                </div>

                <!-- ========== PANEL A: MANUEL GORSEL YUKLE ========== -->
                <div id="panelManual" class="tab-panel" style="display: none;">

                <!-- Gorsel Yukleme -->
                <div class="multi-upload-area">
                    <input type="file" id="manualImageFiles" accept="image/*" multiple style="display: none;">
                    <button id="selectManualFilesBtn" class="btn btn-secondary">
                        <i data-lucide="image-plus" style="width:16px;height:16px;"></i> Gorsel Sec
                    </button>
                    <div id="manualFilesPreview" class="files-preview"></div>
                </div>

                <!-- Post Tipi: Kolaj / Carousel -->
                <div class="post-type-selector">
                    <label>Post Tipi</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manualPostType" value="collage" checked>
                            <span>Kolaj (Tek Gorsel)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manualPostType" value="carousel">
                            <span>Carousel (Kaydirmali)</span>
                        </label>
                    </div>
                </div>

                <!-- Kolaj Stili (kolaj seciliyse gorunur) -->
                <div id="manualLayoutSelector" class="post-type-selector">
                    <label>Kolaj Stili</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manualCollageLayout" value="feature" checked>
                            <span>Feature (1 Buyuk + Kucukler)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manualCollageLayout" value="full_bleed">
                            <span>Grid (Esit Boyut)</span>
                        </label>
                    </div>
                </div>

                <!-- Afis Modu Toggle -->
                <div class="poster-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="manualPosterMode">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Afis Modu (gorselin uzerine kampanya bilgilerini yaz)</span>
                    </label>
                </div>

                <!-- Onizle Butonu -->
                <button id="manualPreviewBtn" class="btn btn-primary btn-block" disabled>
                    <span class="btn-text"><i data-lucide="eye" style="width:16px;height:16px;"></i> Onizle</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Olusturuluyor...
                    </span>
                </button>

                <!-- Onizleme Alani -->
                <div id="manualPreview" style="display: none; margin-top: 1.5rem;">
                    <h3>Onizleme</h3>
                    <div class="image-container">
                        <img id="manualPreviewImage" src="" alt="Onizleme">
                    </div>

                    <!-- Poster Ayar (afis modunda gorunur) -->
                    <div id="manualPosterAdjuster" class="position-adjuster" style="display: none;">
                        <label>Afis Duzenle</label>
                        <div class="edit-field">
                            <span class="edit-label">Baslik</span>
                            <input type="text" id="manualPosterTitle" class="edit-input" placeholder="Kampanya basligi">
                        </div>
                        <div class="edit-field">
                            <span class="edit-label">Indirim</span>
                            <input type="text" id="manualPosterDiscount" class="edit-input edit-input-short" placeholder="Indirim bilgisi">
                        </div>
                        <div class="edit-field">
                            <span class="edit-label">Konum</span>
                            <div class="slider-row">
                                <span class="slider-label">Yukari</span>
                                <input type="range" id="manualPositionSlider" min="20" max="85" value="65" class="position-slider">
                                <span class="slider-label">Asagi</span>
                            </div>
                        </div>
                        <button id="manualApplyPositionBtn" class="btn btn-secondary btn-sm">
                            <span class="btn-text"><i data-lucide="refresh-cw" style="width:14px;height:14px;"></i> Uygula</span>
                            <span class="btn-loader" style="display: none;">
                                <span class="spinner"></span> Render...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- AI Caption Uret -->
                <div style="margin-top: 1.5rem;">
                    <button id="generateCaptionBtn" class="btn btn-primary btn-block" disabled>
                        <span class="btn-text"><i data-lucide="message-square" style="width:16px;height:16px;"></i> AI Caption Uret</span>
                        <span class="btn-loader" style="display: none;">
                            <span class="spinner"></span> Caption uretiliyor...
                        </span>
                    </button>
                    <div class="text-container" style="margin-top: 1rem;">
                        <textarea id="manualCaption" rows="4" placeholder="Caption buraya gelecek... (AI ile uretebilir veya kendiniz yazabilirsiniz)"></textarea>
                    </div>
                </div>

                <!-- Instagram Paylas -->
                <div class="action-buttons multi-actions" style="margin-top: 0.75rem;">
                    <button id="manualInstagramBtn" class="btn btn-instagram" disabled>
                        <i data-lucide="send" style="width:16px;height:16px;"></i> Instagram'a Paylas
                    </button>
                </div>
                </div>

                <!-- ========== PANEL B: AI ILE POST URET ========== -->
                <div id="panelAI" class="tab-panel" style="display: none;">

                <!-- Poster Modu Toggle -->
                <div class="poster-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="aiPosterMode">
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Afis Modu (gorselin uzerine kampanya bilgilerini yaz)</span>
                    </label>
                </div>

                <!-- Icerik Olustur Butonu -->
                <button id="generateBtn" class="btn btn-primary btn-block">
                    <span class="btn-text"><i data-lucide="wand-2" style="width:16px;height:16px;"></i> Icerik Olustur</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Olusturuluyor...
                    </span>
                </button>

                <!-- AI Sonuc Alani -->
                <div id="aiResultSection" style="display: none; margin-top: 1.5rem;">
                    <h3>Gorsel</h3>
                    <div class="image-container">
                        <img id="aiGeneratedImage" src="" alt="Kampanya Gorseli">
                    </div>

                    <div class="text-container" style="margin-top: 1.5rem;">
                        <h3>Instagram Post Metni</h3>
                        <textarea id="aiGeneratedText" rows="6" placeholder="Caption buraya gelecek..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button id="aiCopyTextBtn" class="btn btn-secondary">
                            <i data-lucide="copy" style="width:16px;height:16px;"></i> Metni Kopyala
                        </button>
                        <button id="aiDownloadBtn" class="btn btn-success">
                            <i data-lucide="download" style="width:16px;height:16px;"></i> Desktop'a Kaydet
                        </button>
                        <button id="aiInstagramBtn" class="btn btn-instagram">
                            <i data-lucide="send" style="width:16px;height:16px;"></i> Instagram'a Paylas
                        </button>
                    </div>
                </div>
            </div>

            <!-- ========== PANEL 2: KAMPANYA GORSELI COGALT ========== -->
            <div id="panelCampaignVisual" class="tab-panel" style="display: none;">
                <p class="section-desc">Kampanya gorsellerini yukleyin, AI ile afis formatinda cogaltin.</p>

                <div class="multi-upload-area">
                    <input type="file" id="visualMultiplyFiles" accept="image/*" multiple style="display: none;">
                    <button id="selectVisualMultiplyFilesBtn" class="btn btn-secondary">
                        <i data-lucide="image-plus" style="width:16px;height:16px;"></i> Gorsel Sec
                    </button>
                    <div id="visualMultiplyFilesPreview" class="files-preview"></div>
                </div>

                <button id="visualMultiplyBtn" class="btn btn-primary btn-block" disabled>
                    <span class="btn-text"><i data-lucide="wand-2" style="width:16px;height:16px;"></i> Kampanya Gorseli Cogalt</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> Olusturuluyor...
                    </span>
                </button>

                <div id="visualMultiplyResult" style="display: none; margin-top: 1.5rem;">
                    <h3>Cogaltilan Gorsel</h3>
                    <div class="image-container">
                        <img id="visualMultiplyImage" src="" alt="Cogaltilan Kampanya Gorseli">
                    </div>
                </div>
            </div>
        </div>

        <!-- HATA MESAJI -->
        <div id="errorAlert" class="alert alert-error" style="display: none;">
            <span class="alert-icon"><i data-lucide="alert-triangle" style="width:16px;height:16px;"></i></span>
            <span id="errorMessage"></span>
        </div>
    </main>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== THEME TOGGLE ==========
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.body.classList.add('theme-transitioning');
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            setTimeout(() => document.body.classList.remove('theme-transitioning'), 350);
        });

        const campaignSelect = document.getElementById('campaignSelect');
        const generateBtn = document.getElementById('generateBtn');
        const campaignInfo = document.getElementById('campaignInfo');
        const errorAlert = document.getElementById('errorAlert');
        const modeTabContainer = document.getElementById('modeTabContainer');
        const primaryTabContainer = document.getElementById('primaryTabContainer');

        // ========== KAMPANYA URL'DEN EKLEME ==========
        const addCampaignBtn = document.getElementById('addCampaignBtn');
        const campaignUrlInput = document.getElementById('campaignUrl');
        const addCampaignError = document.getElementById('addCampaignError');
        const addCampaignSuccess = document.getElementById('addCampaignSuccess');

        addCampaignBtn.addEventListener('click', async function() {
            const url = campaignUrlInput.value.trim();
            if (!url) {
                addCampaignError.style.display = 'flex';
                document.getElementById('addCampaignErrorMsg').textContent = 'Lutfen bir URL girin';
                return;
            }

            addCampaignBtn.disabled = true;
            addCampaignBtn.querySelector('.btn-text').style.display = 'none';
            addCampaignBtn.querySelector('.btn-loader').style.display = 'inline-flex';
            addCampaignError.style.display = 'none';
            addCampaignSuccess.style.display = 'none';

            try {
                const response = await fetch('/add-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Bir hata olustu');

                const campaign = data.campaign;
                const option = document.createElement('option');
                option.value = campaign.id;
                option.dataset.title = campaign.title;
                option.dataset.category = campaign.category;
                option.dataset.discount = campaign.discount;
                option.dataset.url = url;
                option.textContent = `${campaign.title} - ${campaign.discount} indirim`;
                campaignSelect.appendChild(option);

                campaignSelect.value = campaign.id;
                campaignSelect.dispatchEvent(new Event('change'));

                addCampaignSuccess.style.display = 'flex';
                document.getElementById('addCampaignSuccessMsg').textContent =
                    `"${campaign.title}" kampanyasi eklendi!`;
                campaignUrlInput.value = '';

            } catch (error) {
                addCampaignError.style.display = 'flex';
                document.getElementById('addCampaignErrorMsg').textContent = error.message;
            } finally {
                addCampaignBtn.disabled = false;
                addCampaignBtn.querySelector('.btn-text').style.display = 'inline';
                addCampaignBtn.querySelector('.btn-loader').style.display = 'none';
            }
        });

        campaignUrlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') addCampaignBtn.click();
        });

        // ========== KAMPANYA SECIMI ==========
        campaignSelect.addEventListener('change', async function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
                campaignInfo.style.display = 'block';
                primaryTabContainer.style.display = 'flex';
                modeTabContainer.style.display = 'flex';

                // Alanlar bossa otomatik scrape et
                if (!selectedOption.dataset.title) {
                    generateBtn.disabled = true;
                    document.getElementById('generateCaptionBtn').disabled = true;
                    document.getElementById('infoTitle').value = '';
                    document.getElementById('infoCategory').value = '';
                    document.getElementById('infoDiscount').value = '';

                    const saveBtn = document.getElementById('saveEditBtn');
                    const origSaveText = saveBtn.textContent;
                    saveBtn.textContent = 'Analiz ediliyor...';
                    saveBtn.disabled = true;

                    try {
                        const resp = await fetch('/scrape-campaign', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ campaign_id: parseInt(this.value) })
                        });
                        const data = await resp.json();
                        if (!resp.ok) throw new Error(data.error);

                        const c = data.campaign;
                        selectedOption.dataset.title = c.title;
                        selectedOption.dataset.category = c.category;
                        selectedOption.dataset.discount = c.discount;
                        selectedOption.textContent = `${c.title} - ${c.discount} indirim`;

                        document.getElementById('infoTitle').value = c.title;
                        document.getElementById('infoCategory').value = c.category;
                        document.getElementById('infoDiscount').value = c.discount;
                        generateBtn.disabled = false;
                        document.getElementById('generateCaptionBtn').disabled = false;
                    } catch (err) {
                        errorAlert.style.display = 'flex';
                        document.getElementById('errorMessage').textContent = 'Scrape hatasi: ' + err.message;
                    } finally {
                        saveBtn.textContent = origSaveText;
                        saveBtn.disabled = false;
                    }
                } else {
                    document.getElementById('infoTitle').value = selectedOption.dataset.title;
                    document.getElementById('infoCategory').value = selectedOption.dataset.category;
                    document.getElementById('infoDiscount').value = selectedOption.dataset.discount;
                    generateBtn.disabled = false;
                    document.getElementById('generateCaptionBtn').disabled = false;
                }
                document.getElementById('visualMultiplyBtn').disabled =
                    document.getElementById('visualMultiplyFiles').files.length === 0;

                // Ilk ana tab'i aktive et
                if (document.getElementById('panelInstagramFlow').style.display === 'none' &&
                    document.getElementById('panelCampaignVisual').style.display === 'none') {
                    switchPrimaryTab('instagram');
                }
            } else {
                campaignInfo.style.display = 'none';
                primaryTabContainer.style.display = 'none';
                modeTabContainer.style.display = 'none';
                document.getElementById('panelInstagramFlow').style.display = 'none';
                document.getElementById('panelCampaignVisual').style.display = 'none';
                document.getElementById('panelManual').style.display = 'none';
                document.getElementById('panelAI').style.display = 'none';
                generateBtn.disabled = true;
                document.getElementById('generateCaptionBtn').disabled = true;
                document.getElementById('visualMultiplyBtn').disabled = true;
            }

            document.getElementById('aiResultSection').style.display = 'none';
            document.getElementById('manualPreview').style.display = 'none';
            document.getElementById('visualMultiplyResult').style.display = 'none';
            errorAlert.style.display = 'none';
        });

        // Kampanya bilgilerini kaydet
        document.getElementById('saveEditBtn').addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            const newTitle = document.getElementById('infoTitle').value.trim();
            const newCategory = document.getElementById('infoCategory').value.trim();
            const newDiscount = document.getElementById('infoDiscount').value.trim();

            if (!newTitle || !newCategory || !newDiscount) {
                alert('Tum alanlari doldurun');
                return;
            }

            try {
                const response = await fetch('/update-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: parseInt(campaignId),
                        title: newTitle,
                        category: newCategory,
                        discount: newDiscount
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                const selectedOption = campaignSelect.options[campaignSelect.selectedIndex];
                selectedOption.dataset.title = newTitle;
                selectedOption.dataset.category = newCategory;
                selectedOption.dataset.discount = newDiscount;
                selectedOption.textContent = `${newTitle} - ${newDiscount} indirim`;

                const originalText = this.textContent;
                this.textContent = 'Kaydedildi!';
                this.classList.add('btn-success-flash');
                setTimeout(() => { this.textContent = originalText; this.classList.remove('btn-success-flash'); }, 2000);
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // ========== ANA TAB SWITCHING ==========
        const tabInstagramFlow = document.getElementById('tabInstagramFlow');
        const tabCampaignVisual = document.getElementById('tabCampaignVisual');
        const panelInstagramFlow = document.getElementById('panelInstagramFlow');
        const panelCampaignVisual = document.getElementById('panelCampaignVisual');

        function switchPrimaryTab(tabName) {
            tabInstagramFlow.classList.toggle('active', tabName === 'instagram');
            tabCampaignVisual.classList.toggle('active', tabName === 'campaign-visual');
            panelInstagramFlow.style.display = tabName === 'instagram' ? 'block' : 'none';
            panelCampaignVisual.style.display = tabName === 'campaign-visual' ? 'block' : 'none';

            if (tabName === 'instagram') {
                modeTabContainer.style.display = 'flex';
                if (panelManual.style.display === 'none' && panelAI.style.display === 'none') {
                    switchTab('manual');
                }
            } else {
                modeTabContainer.style.display = 'none';
                panelManual.style.display = 'none';
                panelAI.style.display = 'none';
            }
        }

        tabInstagramFlow.addEventListener('click', () => switchPrimaryTab('instagram'));
        tabCampaignVisual.addEventListener('click', () => switchPrimaryTab('campaign-visual'));

        // ========== ALT TAB SWITCHING ==========
        const tabManual = document.getElementById('tabManual');
        const tabAI = document.getElementById('tabAI');
        const panelManual = document.getElementById('panelManual');
        const panelAI = document.getElementById('panelAI');

        function switchTab(tabName) {
            tabManual.classList.toggle('active', tabName === 'manual');
            tabAI.classList.toggle('active', tabName === 'ai');
            panelManual.style.display = tabName === 'manual' ? 'block' : 'none';
            panelAI.style.display = tabName === 'ai' ? 'block' : 'none';
        }

        tabManual.addEventListener('click', () => switchTab('manual'));
        tabAI.addEventListener('click', () => switchTab('ai'));

        // ========== KAMPANYA GORSELI COGALT ==========
        const visualMultiplyFilesInput = document.getElementById('visualMultiplyFiles');
        const selectVisualMultiplyFilesBtn = document.getElementById('selectVisualMultiplyFilesBtn');
        const visualMultiplyFilesPreview = document.getElementById('visualMultiplyFilesPreview');
        const visualMultiplyBtn = document.getElementById('visualMultiplyBtn');

        selectVisualMultiplyFilesBtn.addEventListener('click', () => visualMultiplyFilesInput.click());

        visualMultiplyFilesInput.addEventListener('change', function() {
            const files = Array.from(this.files).slice(0, 4);
            visualMultiplyFilesPreview.innerHTML = '';
            document.getElementById('visualMultiplyResult').style.display = 'none';

            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Visual Preview ${idx + 1}">
                        <span class="preview-number">${idx + 1}</span>
                    `;
                    visualMultiplyFilesPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            visualMultiplyBtn.disabled = files.length === 0 || !campaignSelect.value;
        });

        visualMultiplyBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) {
                alert('Once kampanya secin');
                return;
            }

            const files = Array.from(visualMultiplyFilesInput.files).slice(0, 4);
            if (!files.length) {
                alert('Lutfen en az 1 gorsel secin');
                return;
            }

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                const formData = new FormData();
                files.forEach(file => formData.append('files', file));
                formData.append('campaign_id', campaignId);
                formData.append('ai_mode', 'true');

                const response = await fetch('/create-posters', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Bir hata olustu');

                document.getElementById('visualMultiplyImage').src =
                    'data:image/jpeg;base64,' + data.poster.image_base64;
                document.getElementById('visualMultiplyResult').style.display = 'block';
                document.getElementById('visualMultiplyResult').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // ========== MANUEL GORSEL YUKLE TAB ==========
        let manualUploadedUrls = [];
        let manualCollageUrl = null;
        let manualPosterUrl = null;
        let manualRawBase64 = null;

        const manualFileInput = document.getElementById('manualImageFiles');
        const selectManualFilesBtn = document.getElementById('selectManualFilesBtn');
        const manualFilesPreview = document.getElementById('manualFilesPreview');
        const manualPreviewBtn = document.getElementById('manualPreviewBtn');
        const manualInstagramBtn = document.getElementById('manualInstagramBtn');
        const generateCaptionBtn = document.getElementById('generateCaptionBtn');

        // Dosya secme
        selectManualFilesBtn.addEventListener('click', () => manualFileInput.click());

        manualFileInput.addEventListener('change', function() {
            manualFilesPreview.innerHTML = '';
            manualUploadedUrls = [];
            manualCollageUrl = null;
            manualPosterUrl = null;
            manualRawBase64 = null;
            document.getElementById('manualPreview').style.display = 'none';
            manualInstagramBtn.disabled = true;

            const postType = document.querySelector('input[name="manualPostType"]:checked').value;
            const maxFiles = postType === 'carousel' ? 10 : 4;
            const files = Array.from(this.files).slice(0, maxFiles);

            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${idx + 1}">
                        <span class="preview-number">${idx + 1}</span>
                    `;
                    manualFilesPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            manualPreviewBtn.disabled = files.length === 0;
        });

        // Post tipi degisince
        document.querySelectorAll('input[name="manualPostType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isCollage = this.value === 'collage';
                document.getElementById('manualLayoutSelector').style.display = isCollage ? 'block' : 'none';
                // Dosya secimini sifirla
                manualFileInput.value = '';
                manualFilesPreview.innerHTML = '';
                manualUploadedUrls = [];
                manualCollageUrl = null;
                manualPosterUrl = null;
                document.getElementById('manualPreview').style.display = 'none';
                manualPreviewBtn.disabled = true;
                manualInstagramBtn.disabled = true;
            });
        });

        // AI Caption uret
        generateCaptionBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                const response = await fetch('/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campaign_id: parseInt(campaignId) })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                document.getElementById('manualCaption').value = data.caption;
            } catch (error) {
                alert('Caption uretme hatasi: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Onizle butonu
        manualPreviewBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) { alert('Once kampanya secin'); return; }

            const files = Array.from(manualFileInput.files);
            const postType = document.querySelector('input[name="manualPostType"]:checked').value;
            const maxFiles = postType === 'carousel' ? 10 : 4;
            const slicedFiles = files.slice(0, maxFiles);
            if (!slicedFiles.length) return;

            const posterMode = document.getElementById('manualPosterMode').checked;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                if (postType === 'collage') {
                    const formData = new FormData();
                    slicedFiles.forEach(file => formData.append('files', file));

                    if (posterMode) {
                        formData.append('campaign_id', campaignId);
                        formData.append('ai_mode', 'false');

                        const response = await fetch('/create-posters', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);

                        manualPosterUrl = data.poster.image_url;
                        manualRawBase64 = data.raw_image_base64;
                        document.getElementById('manualPreviewImage').src =
                            'data:image/jpeg;base64,' + data.poster.image_base64;

                        const selOpt = campaignSelect.options[campaignSelect.selectedIndex];
                        document.getElementById('manualPosterTitle').value = selOpt.dataset.title || '';
                        document.getElementById('manualPosterDiscount').value = selOpt.dataset.discount || '';
                        document.getElementById('manualPosterAdjuster').style.display = 'block';
                    } else {
                        const layout = document.querySelector('input[name="manualCollageLayout"]:checked').value;
                        formData.append('layout', layout);

                        const response = await fetch('/create-collage', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);

                        manualCollageUrl = data.image_url;
                        document.getElementById('manualPreviewImage').src =
                            'data:image/jpeg;base64,' + data.image_base64;
                        document.getElementById('manualPosterAdjuster').style.display = 'none';
                    }
                } else {
                    // Carousel: gorselleri yukle
                    const formData = new FormData();
                    slicedFiles.forEach(file => formData.append('files', file));

                    const response = await fetch('/upload-images', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    manualUploadedUrls = data.urls;

                    // Ilk gorseli onizleme olarak goster
                    if (slicedFiles.length > 0) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('manualPreviewImage').src = e.target.result;
                        };
                        reader.readAsDataURL(slicedFiles[0]);
                    }
                    document.getElementById('manualPosterAdjuster').style.display = 'none';
                }

                document.getElementById('manualPreview').style.display = 'block';
                manualInstagramBtn.disabled = false;
                document.getElementById('manualPreview').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Poster konum ayarla
        document.getElementById('manualApplyPositionBtn').addEventListener('click', async function() {
            if (!manualRawBase64) { alert('Once onizleme yapin'); return; }
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            const customTitle = document.getElementById('manualPosterTitle').value.trim();
            const customDiscount = document.getElementById('manualPosterDiscount').value.trim();
            if (!customTitle || !customDiscount) { alert('Baslik ve indirim alanlari bos olamaz'); return; }

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';

            try {
                const response = await fetch('/adjust-poster', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_image_base64: manualRawBase64,
                        campaign_id: parseInt(campaignId),
                        title_y_percent: parseInt(document.getElementById('manualPositionSlider').value),
                        title: customTitle,
                        discount: customDiscount,
                        mode: 'basic',
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                manualPosterUrl = data.poster.image_url;
                document.getElementById('manualPreviewImage').src =
                    'data:image/jpeg;base64,' + data.poster.image_base64;
            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Manuel Instagram paylas
        manualInstagramBtn.addEventListener('click', async function() {
            const caption = document.getElementById('manualCaption').value.trim();
            if (!caption) { alert('Lutfen caption yazin veya AI ile uretin!'); return; }

            const postType = document.querySelector('input[name="manualPostType"]:checked').value;

            if (!confirm('Instagram\'a paylasmak istiyor musunuz?')) return;

            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Paylasiliyor...';

            try {
                let response;
                if (postType === 'carousel' && manualUploadedUrls.length >= 2) {
                    response = await fetch('/post-instagram-carousel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_urls: manualUploadedUrls, caption: caption })
                    });
                } else {
                    const imageUrl = manualPosterUrl || manualCollageUrl;
                    if (!imageUrl) throw new Error('Once onizleme yapin');
                    response = await fetch('/post-instagram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_url: imageUrl, caption: caption })
                    });
                }

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                this.textContent = 'Paylasildi!';
                alert(data.message + '\nPost ID: ' + data.post_id);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 3000);

            } catch (error) {
                alert('Hata: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // ========== AI ILE POST URET TAB ==========
        let currentAiImageUrl = null;

        generateBtn.addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            if (!campaignId) return;

            this.disabled = true;
            this.querySelector('.btn-text').style.display = 'none';
            this.querySelector('.btn-loader').style.display = 'inline-flex';
            document.getElementById('aiResultSection').style.display = 'none';
            errorAlert.style.display = 'none';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: parseInt(campaignId),
                        poster_mode: document.getElementById('aiPosterMode').checked
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Bir hata olustu');

                document.getElementById('aiGeneratedImage').src =
                    'data:image/jpeg;base64,' + data.image_base64;
                document.getElementById('aiGeneratedText').value = data.post_text;
                document.getElementById('aiResultSection').style.display = 'block';
                currentAiImageUrl = data.image_url;

                document.getElementById('aiResultSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                errorAlert.style.display = 'flex';
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                this.disabled = false;
                this.querySelector('.btn-text').style.display = 'inline';
                this.querySelector('.btn-loader').style.display = 'none';
            }
        });

        // Metni kopyala
        document.getElementById('aiCopyTextBtn').addEventListener('click', function() {
            const text = document.getElementById('aiGeneratedText').value;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = this.textContent;
                this.textContent = 'Kopyalandi!';
                this.classList.add('btn-success-flash');
                setTimeout(() => { this.textContent = originalText; this.classList.remove('btn-success-flash'); }, 2000);
            });
        });

        // Desktop'a kaydet
        document.getElementById('aiDownloadBtn').addEventListener('click', async function() {
            const campaignId = campaignSelect.value;
            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Kaydediliyor...';

            try {
                const response = await fetch(`/download/${campaignId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Kayit basarisiz');

                this.textContent = 'Kaydedildi!';
                alert(data.message);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 2000);
            } catch (error) {
                alert('Hata: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // AI Instagram paylas
        document.getElementById('aiInstagramBtn').addEventListener('click', async function() {
            const caption = document.getElementById('aiGeneratedText').value.trim();
            if (!currentAiImageUrl || !caption) {
                alert('Once icerik olusturmalisiniz!');
                return;
            }
            if (!confirm('Instagram\'a paylasmak istiyor musunuz?')) return;

            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'Paylasiliyor...';

            try {
                const response = await fetch('/post-instagram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: currentAiImageUrl, caption: caption })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Paylasim basarisiz');

                this.textContent = 'Paylasildi!';
                alert(data.message + '\nPost ID: ' + data.post_id);
                setTimeout(() => { this.textContent = originalText; this.disabled = false; }, 3000);
            } catch (error) {
                alert('Hata: ' + error.message);
                this.textContent = originalText;
                this.disabled = false;
            }
        });
    </script>
</body>
</html>
