# Grupanya Content Engine - Project Report

## Overview
AI-powered content generation tool. Use cases:
  1) Campaign Visual Generation
      - Campaign visuals are generated using campaign details and (optionally) reference images.
  2) Instagram Post Automation
      - Generates Instagram visuals and captions using campaign details. Posts directly to Instagram.

---

## File Structure and Purposes

```
grupanya-content-engine/
├── app.py                          # Flask app creation, blueprint registration, index route
├── routes/                         # Flask Blueprints (API endpoints)
│   ├── campaigns.py                # Campaign CRUD: /add-campaign, /scrape-campaign, /update-campaign
│   ├── generation.py               # AI generation: /generate, /generate-caption, /generate-website-content, /download
│   ├── instagram.py                # Instagram posting: /post-instagram, /post-instagram-carousel
│   └── media.py                    # Image processing: /upload-image, /upload-images, /create-collage, /create-posters, /adjust-poster
├── services/                       # Business logic layer
│   ├── campaigns.py                # Campaign CRUD operations (load/save), constants
│   ├── scraper.py                  # Web scraping and AI info extraction
│   └── content.py                  # AI content generation (image, caption, website)
├── main.py                         # CLI interface - testing and manual content generation
├── scheduler.py                    # Automated scheduling engine via GitHub Actions
├── instagram.py                    # Instagram Graph API integration
├── poster.py                       # Poster/image creation with Pillow
├── collage.py                      # Multi-image collage layouts
├── requirements.txt                # Python dependencies
├── campaigns.json                  # Campaign data (gitignored)
├── campaigns.example.json          # campaigns.json template
├── .env                            # API keys (gitignored)
├── .env.example                    # Environment variables template
├── static/
│   └── css/
│       └── style.css               # UI styles (light/dark theme)
├── templates/
│   └── index.html                  # Flask web interface (responsive, interactive)
└── .github/
    └── workflows/
        └── schedule.yml            # GitHub Actions automation (3 times daily)
```

---

## Technologies Used

| Layer | Technology | Reason |
|-------|-----------|--------|
| **Web Framework** | Flask | Lightweight, fast dashboard and API serving |
| **AI Image Generation** | fal.ai (Flux) | Campaign image creation and img2img stylization |
| **LLM** | Openai/gpt-4o (via fal.ai) | Campaign info extraction, caption writing, style prompt generation |
| **Image Processing** | Pillow | Poster creation, text placement, collage layout |
| **Web Scraping** | BeautifulSoup4 | Extracting info and images from campaign pages |
| **HTTP** | requests | API calls and image downloading |
| **Social Media** | Instagram Graph API v19.0 | Single/carousel post publishing |
| **Automation** | GitHub Actions (cron) | Automated posting 3 times daily on weekdays |
| **Frontend** | HTML5 + CSS3 + Vanilla JS | Tab-based UI, drag-drop, real-time preview |
| **Icons** | Lucide (CDN) | Modern UI icons |
| **Fonts** | Google Fonts (Inter), Arial Unicode/DejaVu | Turkish character support |

---

## Main Workflows

### 1. Campaign Visual Generation

```
Select campaign → (Optional) Upload reference image → Generate image with AI → Download
```

- AI generates visuals using campaign details
- Optionally, reference images can be uploaded (1-4 images)
- With reference images: Collage → Flux img2img stylization
- Without reference images: AI generates image from scratch using campaign info
- Generated image can be previewed and downloaded

### 2. Instagram Post Automation

```
Select campaign → Upload/generate image → Create caption → Post to Instagram
```

- Generates Instagram visuals and captions using campaign details
- Two sub-modes: Manual image upload (collage/carousel) or AI generation
- Caption is generated by AI or written manually
- Post is published directly to Instagram (single image or carousel)

### 3. Automated Scheduler (GitHub Actions)

```
Cron triggers (09:00, 11:20, 18:00 TR) → Select campaign → Scrape page → Find/generate image → Write caption → Post to Instagram
```

- GitHub Actions triggers 3 times daily on weekdays
- Deterministic algorithm selects a campaign for each slot
- Page is scraped, images and info are extracted
- If images exist, create poster; otherwise generate image with AI
- Caption is written by GPT and posted automatically

---

## Core Modules

### app.py - Flask Application Entry Point

Blueprint registrations and index route. All endpoints are separated into modules under `routes/`.

### routes/ - API Endpoints (Flask Blueprints)

| Module | Routes | Description |
|--------|--------|-------------|
| **campaigns.py** | `/add-campaign`, `/scrape-campaign`, `/update-campaign` | Campaign CRUD operations |
| **generation.py** | `/generate`, `/generate-caption`, `/generate-website-content`, `/download/<id>` | AI content generation |
| **instagram.py** | `/post-instagram`, `/post-instagram-carousel` | Instagram posting |
| **media.py** | `/upload-image`, `/upload-images`, `/create-collage`, `/create-posters`, `/adjust-poster` | Image upload and processing |

**All Endpoints:**

| Route | Method | Blueprint | Description |
|-------|--------|-----------|-------------|
| `/` | GET | app | Main dashboard, campaign list |
| `/add-campaign` | POST | campaigns | Add campaign by URL (AI extracts info) |
| `/scrape-campaign` | POST | campaigns | Re-scrape campaign URL |
| `/update-campaign` | POST | campaigns | Edit campaign title/category/discount |
| `/generate` | POST | generation | Generate content with AI (image + caption) |
| `/generate-caption` | POST | generation | Generate Instagram caption with AI |
| `/generate-website-content` | POST | generation | Generate campaign image for website |
| `/download/<campaign_id>` | GET | generation | Download generated content |
| `/create-posters` | POST | media | Create poster from uploaded images |
| `/adjust-poster` | POST | media | Adjust text position on poster |
| `/create-collage` | POST | media | Create multi-image collage layout |
| `/upload-image` | POST | media | Upload single image (fal.ai) |
| `/upload-images` | POST | media | Upload multiple images (fal.ai) |
| `/post-instagram` | POST | instagram | Single image Instagram post |
| `/post-instagram-carousel` | POST | instagram | Carousel Instagram post |

### services/ - Business Logic Layer

| Module | Functions | Description |
|--------|-----------|-------------|
| **campaigns.py** | `load_campaigns()`, `save_campaigns()` | Campaign data read/write, `DEFAULT_NEGATIVE_PROMPT` constant |
| **scraper.py** | `scrape_campaign_page()`, `extract_campaign_info()` | Scraping with BeautifulSoup, info extraction with GPT-4o-mini |
| **content.py** | `generate_instagram_content()`, `generate_caption()`, `generate_website_content()` | Image + caption generation via fal.ai workflow, img2img stylization |

---

### poster.py - Poster Creation Engine

Pillow-based poster creation system.

**Functions:**

- `create_poster()` - Single image + text overlay
  - Gradient background overlay (darker at the bottom)
  - Automatic text wrapping and shadow effect
  - Discount badge (red rounded rectangle)
  - Adjustable text position (0%-90% vertical)

- `create_poster_from_multiple()` - Multi-image layout
  - 62% image area, 38% info area
  - Different layouts for 1, 2, 3, 4+ images
  - Gradient transition and accent line separator

- `create_raw_collage()` - Multi-image grid (no text)
  - Raw collage before AI stylization
  - Crop-to-fill logic (no empty space)

**Output:** 1080x1350px (Instagram 4:5), JPEG quality 95

---

### collage.py - Collage Layout Engine

Multi-image arrangement system.

**Layouts:**

- `create_full_bleed_grid()` - Equal-sized grid, minimal spacing (0-5px)
- `create_feature_layout()` - 1 large + smaller images
  - 2 images: 2/3 left large, 1/3 right small
  - 3 images: 50%/50% split
  - 4 images: Left large, right 3 stacked
  - 5+ images: Left 55%, right grid

---

### scheduler.py - Scheduling Engine

Automated content generation and posting via GitHub Actions.

**Features:**

- Turkey timezone-aware scheduling (UTC+3)
- Deterministic campaign selection (different campaign per slot)
- Cascading fallback: local file → GitHub Gist → environment variable
- Image deduplication and filtering
- 3 time slots on weekdays: 09:00, 11:20, 18:00

---

### instagram.py - Instagram Integration

Instagram posting via Facebook Graph API v19.0.

**Functions:**

- `post_to_instagram()` - Single image posting
  1. Create media container (image URL + caption)
  2. Wait for processing (10s)
  3. Publish

- `post_carousel_to_instagram()` - Carousel posting (2-10 images)
  1. Create child container for each image
  2. Create parent carousel container
  3. Publish

---

### index.html - Web Interface

Modern, responsive single page application.

- **Navigation:** Brand, status indicator, theme switcher
- **Campaign Management:** Add by URL, dropdown selector, editable fields
- **Two Main Tabs:** Instagram Post Generation / Campaign Visual Generation
- **Sub-modes:** Manual upload, AI generation, collage selector, text position slider
- **Upload:** Multi-file drag-drop, image preview grid
- **Dark Mode:** Persistent theme preference via localStorage

---

### style.css - Style System

- CSS variables for light/dark theme
- Component library: buttons, cards, inputs, alerts, tabs
- Flexbox-based layout, 1080px max width
- Animations: transitions, loading spinners, hover effects
- Inter font (Google Fonts)
- Mobile-first responsive design

---

## Configuration

### Environment Variables (.env)

| Variable | Description |
|----------|-------------|
| `FAL_KEY` | fal.ai API key |
| `INSTAGRAM_ACCESS_TOKEN` | 60-day Instagram token |
| `INSTAGRAM_ACCOUNT_ID` | Instagram business account ID |
| `CAMPAIGNS_GIST_URL` | (Optional) GitHub Gist URL |

### GitHub Actions Secrets

| Secret | Description |
|--------|-------------|
| `FAL_KEY` | fal.ai API key |
| `INSTAGRAM_ACCESS_TOKEN` | Instagram token |
| `INSTAGRAM_ACCOUNT_ID` | Instagram account ID |
| `CAMPAIGNS_GIST_URL` | (Optional) Gist URL |

### Scheduling (schedule.yml)

- **Frequency:** 3 times daily on weekdays
- **Hours (TR):** 09:00, 11:20, 18:00
- **Platform:** Ubuntu-latest, Python 3.11
- **Fonts:** DejaVu (Ubuntu system fonts)

---

## Data Models

### Campaign Object

```json
{
  "id": 1,
  "url": "https://...",
  "title": "Campaign Title",
  "category": "Category description for image generation",
  "discount": "Discount amount/percentage"
}
```

### fal.ai Workflow Endpoints

| Endpoint | Usage |
|----------|-------|
| `workflows/baharyavuz/grupanya-content-engine` | Main content generation |
| `workflows/baharyavuz/grupanya-content-caption` | Caption-only generation |
| `fal-ai/any-llm` | Openai/gpt-4o text generation |
| `fal-ai/flux/dev/image-to-image` | Image stylization |

---

## Architecture Highlights

- **Modular structure:** Route separation via Flask Blueprints, business logic isolation via services layer
- **Cross-platform:** macOS (development) + Linux (GitHub Actions production)
- **Zero-touch automation:** Daily posting with smart campaign rotation
- **Cascading fallback:** 3-tier backup system for campaign data
- **Responsive UI:** Dark mode, drag-drop, real-time preview
- **Extensible:** New layouts, AI models, or social platforms can be easily added

---

## Dependencies (requirements.txt)

```
flask>=3.0.0
requests>=2.31.0
Pillow>=10.0.0
beautifulsoup4>=4.12.0
python-dotenv>=1.0.0
```
